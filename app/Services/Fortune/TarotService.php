<?php

namespace App\Services\Fortune;

/**
 * タロットサービス（78枚対応）
 */
class TarotService
{
    /**
     * 大アルカナ22枚
     */
    private const MAJOR_ARCANA = [
        '愚者', '魔術師', '女教皇', '女帝', '皇帝', '教皇', '恋人',
        '戦車', '力', '隠者', '運命の輪', '正義', '吊された男', '死神',
        '節制', '悪魔', '塔', '星', '月', '太陽', '審判', '世界',
    ];

    /**
     * 小アルカナ56枚（スート別）
     */
    private const MINOR_ARCANA = [
        'ワンド' => ['エース', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'ページ', 'ナイト', 'クイーン', 'キング'],
        'カップ' => ['エース', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'ページ', 'ナイト', 'クイーン', 'キング'],
        'ソード' => ['エース', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'ページ', 'ナイト', 'クイーン', 'キング'],
        'ペンタクル' => ['エース', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'ページ', 'ナイト', 'クイーン', 'キング'],
    ];

    /**
     * タロットカードを1枚引く
     *
     * @param bool $includeReversed 逆位置を含めるか
     * @return array カード情報
     */
    public function drawOne(bool $includeReversed = true): array
    {
        $allCards = $this->getAllCards();
        $card = $allCards[array_rand($allCards)];
        
        $position = $includeReversed && rand(0, 1) === 1 ? '逆位置' : '正位置';
        
        return [
            'card_name' => $card['name'],
            'card_image' => $this->getCardImagePath($card),
            'message' => $this->getCardMessage($card, $position),
            'position' => $position,
            'category' => $card['category'],
        ];
    }

    /**
     * 全78枚のカードリストを取得
     */
    private function getAllCards(): array
    {
        $cards = [];
        
        // 大アルカナ
        foreach (self::MAJOR_ARCANA as $name) {
            $cards[] = [
                'name' => $name,
                'category' => '大アルカナ',
            ];
        }
        
        // 小アルカナ
        foreach (self::MINOR_ARCANA as $suit => $ranks) {
            foreach ($ranks as $rank) {
                $cards[] = [
                    'name' => "{$suit}の{$rank}",
                    'category' => '小アルカナ',
                    'suit' => $suit,
                    'rank' => $rank,
                ];
            }
        }
        
        return $cards;
    }

    /**
     * カード画像のパスを取得
     */
    private function getCardImagePath(array $card): ?string
    {
        // 日本語のカード名を英語のファイル名に変換
        $fileName = $this->convertToEnglishFileName($card);
        
        // PNG形式でチェック
        $localPath = public_path("images/tarot/{$fileName}.png");
        if (file_exists($localPath)) {
            return asset("images/tarot/{$fileName}.png");
        }
        
        // JPG形式でチェック（フォールバック）
        $localPathJpg = public_path("images/tarot/{$fileName}.jpg");
        if (file_exists($localPathJpg)) {
            return asset("images/tarot/{$fileName}.jpg");
        }
        
        // 画像が存在しない場合はnullを返す（プレースホルダー表示）
        return null;
    }

    /**
     * 日本語のカード名を英語のファイル名に変換
     */
    private function convertToEnglishFileName(array $card): string
    {
        $name = $card['name'];
        
        // 大アルカナの場合
        if ($card['category'] === '大アルカナ') {
            $majorArcanaMap = [
                '愚者' => 'fool',
                '魔術師' => 'magician',
                '女教皇' => 'highpriestess',
                '女帝' => 'empress',
                '皇帝' => 'emperor',
                '教皇' => 'hierophant',
                '恋人' => 'lovers',
                '戦車' => 'chariot',
                '力' => 'strength',
                '隠者' => 'hermit',
                '運命の輪' => 'wheeloffortune',
                '正義' => 'justice',
                '吊された男' => 'hangedman',
                '死神' => 'death',
                '節制' => 'temperance',
                '悪魔' => 'devil',
                '塔' => 'tower',
                '星' => 'star',
                '月' => 'moon',
                '太陽' => 'sun',
                '審判' => 'judgement',
                '世界' => 'world',
            ];
            
            return 'tarot-' . ($majorArcanaMap[$name] ?? strtolower(str_replace(' ', '', $name)));
        }
        
        // 小アルカナの場合
        if ($card['category'] === '小アルカナ' && isset($card['suit']) && isset($card['rank'])) {
            $suitMap = [
                'ワンド' => 'wands',
                'カップ' => 'cups',
                'ソード' => 'swords',
                'ペンタクル' => 'pentacles',
            ];
            
            $rankMap = [
                'エース' => '01',
                '2' => '02',
                '3' => '03',
                '4' => '04',
                '5' => '05',
                '6' => '06',
                '7' => '07',
                '8' => '08',
                '9' => '09',
                '10' => '10',
                'ページ' => '11',  // Page
                'ナイト' => '12',  // Knight
                'クイーン' => '13', // Queen
                'キング' => '14',  // King
            ];
            
            $suit = $suitMap[$card['suit']] ?? strtolower($card['suit']);
            $rank = $rankMap[$card['rank']] ?? $card['rank'];
            
            return "tarot-{$suit}-{$rank}";
        }
        
        // フォールバック
        return 'tarot-' . strtolower(str_replace([' ', 'の'], ['', ''], $name));
    }

    /**
     * カードのメッセージを取得
     */
    private function getCardMessage(array $card, string $position): string
    {
        $cardName = $card['name'];
        
        // 大アルカナのメッセージ
        if ($card['category'] === '大アルカナ') {
            return $this->getMajorArcanaMessage($cardName, $position);
        }
        
        // 小アルカナのメッセージ
        if ($card['category'] === '小アルカナ' && isset($card['suit']) && isset($card['rank'])) {
            return $this->getMinorArcanaMessage($card['suit'], $card['rank'], $position);
        }
        
        // フォールバック
        return "「{$cardName}」があなたにメッセージを伝えています。";
    }

    /**
     * 大アルカナのメッセージを取得
     */
    private function getMajorArcanaMessage(string $cardName, string $position): string
    {
        $messages = [
            '愚者' => [
                '正位置' => '新しい始まりの時です。未知の世界へ一歩を踏み出す勇気を持ちましょう。直感を信じて、自由に進んでください。',
                '逆位置' => '軽率な行動に注意が必要です。計画を立て、慎重に判断しましょう。衝動的な決断は避けてください。',
            ],
            '魔術師' => [
                '正位置' => 'あなたには無限の可能性があります。意志の力で目標を実現させましょう。行動を起こすのに最適な時期です。',
                '逆位置' => 'エネルギーが散漫になっているかもしれません。集中力を高め、明確な目標を設定しましょう。',
            ],
            '女教皇' => [
                '正位置' => '内面の声に耳を傾ける時です。直感や内なる知恵を信頼し、静かな時間を作りましょう。',
                '逆位置' => '内面とのつながりが薄れているかもしれません。自分自身と向き合い、心の声を聞いてください。',
            ],
            '女帝' => [
                '正位置' => '豊かさと恵みが訪れる時期です。自然の流れに身を任せ、創造性を発揮しましょう。',
                '逆位置' => '過保護や依存に注意が必要です。自立心を大切にし、バランスを保ちましょう。',
            ],
            '皇帝' => [
                '正位置' => '秩序と安定がもたらされます。リーダーシップを発揮し、計画的な行動を取りましょう。',
                '逆位置' => '権威主義や硬直した考えに注意が必要です。柔軟性を持ち、他者の意見にも耳を傾けましょう。',
            ],
            '教皇' => [
                '正位置' => '伝統や知識から学ぶ時です。信頼できる人からのアドバイスを受け入れ、成長しましょう。',
                '逆位置' => '固定観念や偏見に縛られているかもしれません。新しい視点を持ち、柔軟に考えましょう。',
            ],
            '恋人' => [
                '正位置' => '重要な選択や関係性の深まりが訪れます。愛と調和を大切にし、心に従って決断しましょう。',
                '逆位置' => '関係性のバランスが崩れているかもしれません。コミュニケーションを大切にし、理解を深めましょう。',
            ],
            '戦車' => [
                '正位置' => '目標に向かって力強く進む時です。意志の力で困難を乗り越え、勝利を掴みましょう。',
                '逆位置' => '方向性が定まっていないかもしれません。目標を明確にし、集中して進みましょう。',
            ],
            '力' => [
                '正位置' => '内なる強さと忍耐力が試される時です。優しさと強さのバランスを保ち、困難に立ち向かいましょう。',
                '逆位置' => '感情のコントロールが難しいかもしれません。冷静さを保ち、内なる強さを信じましょう。',
            ],
            '隠者' => [
                '正位置' => '内面を見つめ、真実を探求する時です。一人の時間を大切にし、内なる導きに従いましょう。',
                '逆位置' => '孤独や孤立感を感じているかもしれません。必要な時は他者に助けを求め、つながりを大切にしましょう。',
            ],
            '運命の輪' => [
                '正位置' => '運命の転換点が訪れます。変化を受け入れ、新しいサイクルが始まることを信じましょう。',
                '逆位置' => '運気の停滞を感じているかもしれません。変化を恐れず、積極的に行動を起こしましょう。',
            ],
            '正義' => [
                '正位置' => '公平さと正義が求められる時です。バランスを保ち、誠実に判断を下しましょう。',
                '逆位置' => '偏見や不公平な判断に注意が必要です。客観的な視点を持ち、公正に行動しましょう。',
            ],
            '吊された男' => [
                '正位置' => '新しい視点を得るために、一旦立ち止まる時です。見方を変えることで、新しい気づきが生まれます。',
                '逆位置' => '無駄な犠牲や停滞に注意が必要です。行動を起こし、状況を変える勇気を持ちましょう。',
            ],
            '死神' => [
                '正位置' => '終わりと新しい始まりが訪れます。古いものを手放し、変化を受け入れることで成長できます。',
                '逆位置' => '変化を拒み、過去に執着しているかもしれません。手放す勇気を持ち、新しい道へ進みましょう。',
            ],
            '節制' => [
                '正位置' => 'バランスと調和がもたらされます。異なる要素を統合し、中庸を保ちましょう。',
                '逆位置' => '極端な行動や不均衡に注意が必要です。バランスを取り戻し、調和を大切にしましょう。',
            ],
            '悪魔' => [
                '正位置' => '物質的な欲望や束縛に気づく時です。自由を手に入れるために、執着を手放しましょう。',
                '逆位置' => '束縛から解放される時が近づいています。自由を求める意志を持ち、変化を起こしましょう。',
            ],
            '塔' => [
                '正位置' => '突然の変化や崩壊が訪れるかもしれません。古い構造を壊し、新しい基盤を築く時です。',
                '逆位置' => '変化への抵抗や不安を感じているかもしれません。変化を受け入れ、新しい可能性に目を向けましょう。',
            ],
            '星' => [
                '正位置' => '希望と癒しがもたらされます。未来への希望を抱き、夢に向かって進みましょう。',
                '逆位置' => '希望を見失っているかもしれません。小さな光を見つけ、一歩ずつ前に進みましょう。',
            ],
            '月' => [
                '正位置' => '不安や混乱を感じる時です。直感を信頼し、内なる声に耳を傾けましょう。',
                '逆位置' => '不安が解消され、真実が見えてくる時です。直感を信じ、前進する勇気を持ちましょう。',
            ],
            '太陽' => [
                '正位置' => '喜びと成功が訪れます。明るい未来が待っています。自信を持ち、前向きに進みましょう。',
                '逆位置' => '過度な楽観や現実逃避に注意が必要です。現実を見据え、バランスを保ちましょう。',
            ],
            '審判' => [
                '正位置' => '新しい始まりと再生の時です。過去を振り返り、学びを活かして新たな道へ進みましょう。',
                '逆位置' => '過去への執着や後悔に縛られているかもしれません。過去を手放し、今この瞬間を大切にしましょう。',
            ],
            '世界' => [
                '正位置' => '完成と達成の時です。目標を達成し、新しいサイクルが始まります。充実感と満足感を感じられるでしょう。',
                '逆位置' => '完成への道のりが長く感じられるかもしれません。最後の一歩を踏み出す勇気を持ちましょう。',
            ],
        ];

        return $messages[$cardName][$position] ?? "「{$cardName}」があなたにメッセージを伝えています。";
    }

    /**
     * 小アルカナのメッセージを取得
     */
    private function getMinorArcanaMessage(string $suit, string $rank, string $position): string
    {
        $suitMeanings = [
            'ワンド' => [
                'name' => 'ワンド',
                'theme' => '行動・創造・情熱・意志',
                'element' => '火',
            ],
            'カップ' => [
                'name' => 'カップ',
                'theme' => '感情・愛情・直感・関係性',
                'element' => '水',
            ],
            'ソード' => [
                'name' => 'ソード',
                'theme' => '思考・コミュニケーション・決断・知性',
                'element' => '風',
            ],
            'ペンタクル' => [
                'name' => 'ペンタクル',
                'theme' => '物質・お金・仕事・実用性',
                'element' => '土',
            ],
        ];

        $suitInfo = $suitMeanings[$suit] ?? ['name' => $suit, 'theme' => '', 'element' => ''];
        
        // エース（1）
        if ($rank === 'エース') {
            $messages = [
                'ワンド' => [
                    '正位置' => '新しい始まりと創造のエネルギーが湧き上がっています。情熱を持って行動を起こしましょう。',
                    '逆位置' => 'エネルギーが散漫になっているかもしれません。方向性を定め、集中して進みましょう。',
                ],
                'カップ' => [
                    '正位置' => '新しい愛情や感情的なつながりが生まれる時です。心を開き、感情を大切にしましょう。',
                    '逆位置' => '感情の混乱や閉塞感を感じているかもしれません。心の声に耳を傾け、感情を整理しましょう。',
                ],
                'ソード' => [
                    '正位置' => '新しいアイデアや明確な思考が生まれます。真実を見極め、決断を下しましょう。',
                    '逆位置' => '思考が混乱しているかもしれません。冷静さを保ち、客観的な視点を持ちましょう。',
                ],
                'ペンタクル' => [
                    '正位置' => '新しい機会や物質的な豊かさが訪れます。実用的な計画を立て、行動を起こしましょう。',
                    '逆位置' => '機会を逃しているかもしれません。現実的な視点を持ち、行動を起こす勇気を持ちましょう。',
                ],
            ];
            return $messages[$suit][$position] ?? "「{$suit}の{$rank}」があなたにメッセージを伝えています。";
        }

        // 数字カード（2-10）
        if (in_array($rank, ['2', '3', '4', '5', '6', '7', '8', '9', '10'])) {
            return $this->getNumberCardMessage($suit, $rank, $position, $suitInfo);
        }

        // コートカード（ページ、ナイト、クイーン、キング）
        if (in_array($rank, ['ページ', 'ナイト', 'クイーン', 'キング'])) {
            return $this->getCourtCardMessage($suit, $rank, $position, $suitInfo);
        }

        return "「{$suit}の{$rank}」があなたにメッセージを伝えています。";
    }

    /**
     * 数字カード（2-10）のメッセージを取得
     */
    private function getNumberCardMessage(string $suit, string $rank, string $position, array $suitInfo): string
    {
        $numberMeanings = [
            '2' => ['正位置' => 'バランス・選択・協力', '逆位置' => '不均衡・優柔不断・対立'],
            '3' => ['正位置' => '成長・創造・協力', '逆位置' => '停滞・散漫・不協和'],
            '4' => ['正位置' => '安定・基盤・休息', '逆位置' => '硬直・停滞・制限'],
            '5' => ['正位置' => '変化・挑戦・成長', '逆位置' => '混乱・争い・不安定'],
            '6' => ['正位置' => '調和・解決・前進', '逆位置' => '不均衡・未解決・後退'],
            '7' => ['正位置' => '内省・評価・選択', '逆位置' => '混乱・迷い・優柔不断'],
            '8' => ['正位置' => '進歩・努力・達成', '逆位置' => '停滞・努力不足・遅延'],
            '9' => ['正位置' => '完成・満足・準備', '逆位置' => '未完成・不満・準備不足'],
            '10' => ['正位置' => '完成・達成・新たな始まり', '逆位置' => '過剰・負担・終わりの遅延'],
        ];

        $numberInfo = $numberMeanings[$rank] ?? ['正位置' => '', '逆位置' => ''];

        $suitMessages = [
            'ワンド' => [
                '2' => [
                    '正位置' => '計画を立て、選択肢を検討する時です。協力して目標に向かって進みましょう。',
                    '逆位置' => '優柔不断や対立に注意が必要です。決断を下し、行動を起こしましょう。',
                ],
                '3' => [
                    '正位置' => '創造的なプロジェクトが進展しています。チームワークを大切にし、成長を実感しましょう。',
                    '逆位置' => 'エネルギーが散漫になっているかもしれません。集中し、方向性を定めましょう。',
                ],
                '4' => [
                    '正位置' => '安定した基盤が築かれています。休息を取り、次のステップに備えましょう。',
                    '逆位置' => '硬直した考えや停滞に注意が必要です。柔軟性を持ち、変化を受け入れましょう。',
                ],
                '5' => [
                    '正位置' => '変化と挑戦の時です。困難を乗り越えることで、成長できます。',
                    '逆位置' => '混乱や争いに注意が必要です。冷静さを保ち、協力を大切にしましょう。',
                ],
                '6' => [
                    '正位置' => '努力が実を結び、調和がもたらされます。成功を祝い、次の目標に向かいましょう。',
                    '逆位置' => '不均衡や未解決の問題に注意が必要です。バランスを取り戻し、解決を目指しましょう。',
                ],
                '7' => [
                    '正位置' => '内省し、状況を評価する時です。選択肢を検討し、最善の道を選びましょう。',
                    '逆位置' => '混乱や迷いを感じているかもしれません。明確な目標を設定し、決断を下しましょう。',
                ],
                '8' => [
                    '正位置' => '目標に向かって着実に進んでいます。努力を続け、達成を目指しましょう。',
                    '逆位置' => '停滞や努力不足に注意が必要です。行動を起こし、前進する勇気を持ちましょう。',
                ],
                '9' => [
                    '正位置' => '目標達成まであと一歩です。最後の努力を続け、完成を目指しましょう。',
                    '逆位置' => '未完成や不満を感じているかもしれません。現実を見据え、調整を行いましょう。',
                ],
                '10' => [
                    '正位置' => '目標を達成し、新たな始まりが待っています。成果を喜び、次のステップへ進みましょう。',
                    '逆位置' => '過剰な負担や終わりの遅延に注意が必要です。バランスを取り、休息を大切にしましょう。',
                ],
            ],
            'カップ' => [
                '2' => [
                    '正位置' => '愛情や友情が深まる時です。パートナーシップを大切にし、調和を保ちましょう。',
                    '逆位置' => '関係性の不均衡や対立に注意が必要です。コミュニケーションを大切にし、理解を深めましょう。',
                ],
                '3' => [
                    '正位置' => '喜びと友情に満ちた時です。周囲の人々と楽しい時間を過ごし、絆を深めましょう。',
                    '逆位置' => '過度な社交や表面的な関係に注意が必要です。深いつながりを大切にしましょう。',
                ],
                '4' => [
                    '正位置' => '感情的な休息と内省の時です。過去を振り返り、心の整理をしましょう。',
                    '逆位置' => '感情の停滞や後悔に注意が必要です。過去を手放し、前を向きましょう。',
                ],
                '5' => [
                    '正位置' => '感情的な損失や失望を感じる時です。悲しみを受け入れ、癒しの時間を取りましょう。',
                    '逆位置' => '感情の混乱や否認に注意が必要です。感情を認め、受け入れる勇気を持ちましょう。',
                ],
                '6' => [
                    '正位置' => '過去の思い出や懐かしさを感じる時です。良い思い出を大切にし、感謝の気持ちを持ちましょう。',
                    '逆位置' => '過去への執着に注意が必要です。今この瞬間を大切にし、前進しましょう。',
                ],
                '7' => [
                    '正位置' => '感情的な選択や内省が求められる時です。心の声に耳を傾け、真実を見極めましょう。',
                    '逆位置' => '幻想や自己欺瞞に注意が必要です。現実を見据え、誠実に向き合いましょう。',
                ],
                '8' => [
                    '正位置' => '感情的な成長と前進の時です。過去を手放し、新しい可能性に目を向けましょう。',
                    '逆位置' => '感情的な停滞や後退に注意が必要です。変化を受け入れ、前進する勇気を持ちましょう。',
                ],
                '9' => [
                    '正位置' => '感情的な満足と幸福感がもたらされます。願いが叶い、心が満たされるでしょう。',
                    '逆位置' => '感情的な不満や過度な期待に注意が必要です。現実を見据え、感謝の気持ちを持ちましょう。',
                ],
                '10' => [
                    '正位置' => '感情的な完成と幸福が訪れます。家族や愛する人との絆が深まり、充実感を感じられるでしょう。',
                    '逆位置' => '感情的な過剰や負担に注意が必要です。バランスを取り、休息を大切にしましょう。',
                ],
            ],
            'ソード' => [
                '2' => [
                    '正位置' => '難しい選択や決断が求められる時です。両方の選択肢を検討し、バランスを保ちましょう。',
                    '逆位置' => '優柔不断や混乱に注意が必要です。明確な判断を下し、行動を起こしましょう。',
                ],
                '3' => [
                    '正位置' => '心の痛みや困難を経験する時です。痛みを受け入れ、成長の機会として捉えましょう。',
                    '逆位置' => '感情的な混乱や否認に注意が必要です。現実を受け入れ、前進する勇気を持ちましょう。',
                ],
                '4' => [
                    '正位置' => '休息と回復の時です。心身を休め、次の行動に備えましょう。',
                    '逆位置' => '停滞や逃避に注意が必要です。問題に直面し、解決を目指しましょう。',
                ],
                '5' => [
                    '正位置' => '競争や対立が生じる時です。冷静さを保ち、建設的な解決を目指しましょう。',
                    '逆位置' => '争いや混乱に注意が必要です。協力を大切にし、調和を目指しましょう。',
                ],
                '6' => [
                    '正位置' => '困難から逃れ、新しい環境へ移る時です。変化を受け入れ、前進しましょう。',
                    '逆位置' => '逃避や現実逃避に注意が必要です。問題に直面し、解決を目指しましょう。',
                ],
                '7' => [
                    '正位置' => '策略や計画が必要な時です。慎重に行動し、目標を達成しましょう。',
                    '逆位置' => '策略の失敗や計画の見直しが必要です。正直さを大切にし、再計画を立てましょう。',
                ],
                '8' => [
                    '正位置' => '制限や困難に直面する時です。忍耐強く、困難を乗り越えましょう。',
                    '逆位置' => '束縛からの解放が近づいています。自由を求める意志を持ち、行動を起こしましょう。',
                ],
                '9' => [
                    '正位置' => '深い悲しみや絶望を感じる時です。感情を受け入れ、サポートを求めましょう。',
                    '逆位置' => '希望の光が見えてきます。困難を乗り越え、前進する勇気を持ちましょう。',
                ],
                '10' => [
                    '正位置' => '困難の終わりと新たな始まりが訪れます。過去を手放し、新しい可能性に目を向けましょう。',
                    '逆位置' => '困難の継続や負担に注意が必要です。忍耐強く、支援を求めましょう。',
                ],
            ],
            'ペンタクル' => [
                '2' => [
                    '正位置' => 'バランスを取りながら、複数の選択肢を検討する時です。柔軟性を持ち、最善の道を選びましょう。',
                    '逆位置' => '不均衡や優柔不断に注意が必要です。決断を下し、行動を起こしましょう。',
                ],
                '3' => [
                    '正位置' => '協力と成長の時です。チームワークを大切にし、スキルを向上させましょう。',
                    '逆位置' => '停滞や不協和に注意が必要です。協力を大切にし、成長を目指しましょう。',
                ],
                '4' => [
                    '正位置' => '安定と所有の時です。基盤を固め、将来に備えましょう。',
                    '逆位置' => '不安定や所有への執着に注意が必要です。バランスを取り、柔軟性を持ちましょう。',
                ],
                '5' => [
                    '正位置' => '物質的な困難や損失を経験する時です。支援を求め、困難を乗り越えましょう。',
                    '逆位置' => '困難の改善や回復が近づいています。希望を持ち、前進しましょう。',
                ],
                '6' => [
                    '正位置' => '寛大さと支援の時です。他者を助け、与えることで豊かさがもたらされます。',
                    '逆位置' => '過度な依存や搾取に注意が必要です。自立心を大切にし、バランスを保ちましょう。',
                ],
                '7' => [
                    '正位置' => '努力と成長の時です。スキルを磨き、長期的な視点を持ちましょう。',
                    '逆位置' => '努力不足や焦りに注意が必要です。忍耐強く、着実に進みましょう。',
                ],
                '8' => [
                    '正位置' => '努力と献身が実を結ぶ時です。スキルを活かし、目標を達成しましょう。',
                    '逆位置' => '努力不足や停滞に注意が必要です。行動を起こし、前進する勇気を持ちましょう。',
                ],
                '9' => [
                    '正位置' => '物質的な満足と達成の時です。努力が実を結び、豊かさを感じられるでしょう。',
                    '逆位置' => '不満や未完成に注意が必要です。現実を見据え、調整を行いましょう。',
                ],
                '10' => [
                    '正位置' => '物質的な完成と豊かさがもたらされます。家族や財産に恵まれ、充実感を感じられるでしょう。',
                    '逆位置' => '過剰な負担や物質への執着に注意が必要です。バランスを取り、本当に大切なものを大切にしましょう。',
                ],
            ],
        ];

        return $suitMessages[$suit][$rank][$position] ?? "「{$suitInfo['name']}の{$rank}」があなたにメッセージを伝えています。";
    }

    /**
     * コートカード（ページ、ナイト、クイーン、キング）のメッセージを取得
     */
    private function getCourtCardMessage(string $suit, string $rank, string $position, array $suitInfo): string
    {
        $courtMeanings = [
            'ページ' => [
                'ワンド' => [
                    '正位置' => '新しいアイデアや創造的なプロジェクトが始まります。好奇心を持ち、行動を起こしましょう。',
                    '逆位置' => '衝動的な行動や未熟さに注意が必要です。計画を立て、慎重に進みましょう。',
                ],
                'カップ' => [
                    '正位置' => '新しい感情や直感が生まれます。心を開き、感情を大切にしましょう。',
                    '逆位置' => '感情の混乱や未成熟に注意が必要です。感情を整理し、成長を目指しましょう。',
                ],
                'ソード' => [
                    '正位置' => '新しいアイデアやコミュニケーションが生まれます。好奇心を持ち、学びを大切にしましょう。',
                    '逆位置' => '思考の混乱や未成熟に注意が必要です。冷静さを保ち、知識を深めましょう。',
                ],
                'ペンタクル' => [
                    '正位置' => '新しい機会や学習の時です。実用的なスキルを身につけ、成長を目指しましょう。',
                    '逆位置' => '学習不足や未成熟に注意が必要です。努力を続け、スキルを向上させましょう。',
                ],
            ],
            'ナイト' => [
                'ワンド' => [
                    '正位置' => '行動と冒険の時です。情熱を持って目標に向かい、勇気を持って進みましょう。',
                    '逆位置' => '衝動的な行動や無謀さに注意が必要です。計画を立て、慎重に進みましょう。',
                ],
                'カップ' => [
                    '正位置' => 'ロマンスや感情的な前進が訪れます。感情を大切にし、関係性を深めましょう。',
                    '逆位置' => '感情的な混乱や逃避に注意が必要です。現実を見据え、誠実に向き合いましょう。',
                ],
                'ソード' => [
                    '正位置' => '決断と行動の時です。明確な判断を下し、目標に向かって進みましょう。',
                    '逆位置' => '衝動的な行動や無謀さに注意が必要です。冷静さを保ち、計画を立てましょう。',
                ],
                'ペンタクル' => [
                    '正位置' => '実用的な努力と前進の時です。目標に向かって着実に進み、成果を目指しましょう。',
                    '逆位置' => '停滞や努力不足に注意が必要です。行動を起こし、前進する勇気を持ちましょう。',
                ],
            ],
            'クイーン' => [
                'ワンド' => [
                    '正位置' => '創造性と情熱が満ちています。自信を持ち、目標を実現させましょう。',
                    '逆位置' => '過度な自信や支配欲に注意が必要です。謙虚さを持ち、協力を大切にしましょう。',
                ],
                'カップ' => [
                    '正位置' => '愛情と感情的な豊かさがもたらされます。心を開き、関係性を深めましょう。',
                    '逆位置' => '感情的な不安定や依存に注意が必要です。自立心を大切にし、バランスを保ちましょう。',
                ],
                'ソード' => [
                    '正位置' => '明確な思考とコミュニケーションがもたらされます。真実を語り、理解を深めましょう。',
                    '逆位置' => '厳しすぎる判断や批判に注意が必要です。優しさを持ち、理解を深めましょう。',
                ],
                'ペンタクル' => [
                    '正位置' => '実用的な知恵と豊かさがもたらされます。実用的な計画を立て、目標を達成しましょう。',
                    '逆位置' => '物質への執着や過度な慎重さに注意が必要です。バランスを取り、柔軟性を持ちましょう。',
                ],
            ],
            'キング' => [
                'ワンド' => [
                    '正位置' => 'リーダーシップと創造性が発揮されます。目標を実現し、成功を掴みましょう。',
                    '逆位置' => '独裁的や過度な支配に注意が必要です。協力を大切にし、バランスを保ちましょう。',
                ],
                'カップ' => [
                    '正位置' => '感情的な成熟と調和がもたらされます。愛情を大切にし、関係性を深めましょう。',
                    '逆位置' => '感情的な未成熟や操作に注意が必要です。誠実さを大切にし、理解を深めましょう。',
                ],
                'ソード' => [
                    '正位置' => '明確な判断と知性が発揮されます。真実を見極め、公正に行動しましょう。',
                    '逆位置' => '厳しすぎる判断や冷酷さに注意が必要です。優しさを持ち、理解を深めましょう。',
                ],
                'ペンタクル' => [
                    '正位置' => '実用的な成功と豊かさがもたらされます。計画を立て、目標を達成しましょう。',
                    '逆位置' => '物質への執着や過度な慎重さに注意が必要です。バランスを取り、柔軟性を持ちましょう。',
                ],
            ],
        ];

        return $courtMeanings[$rank][$suit][$position] ?? "「{$suitInfo['name']}の{$rank}」があなたにメッセージを伝えています。";
    }

    /**
     * タロットスプレッドを引く
     *
     * @param int $count 引く枚数
     * @return array カード情報の配列
     */
    public function drawSpread(int $count = 3): array
    {
        $cards = [];
        $drawnCards = [];
        
        for ($i = 0; $i < $count; $i++) {
            do {
                $card = $this->drawOne();
            } while (in_array($card['card_name'], $drawnCards));
            
            $drawnCards[] = $card['card_name'];
            $cards[] = $card;
        }
        
        return $cards;
    }
}

